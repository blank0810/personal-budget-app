// This is your Prisma schema file
// Personal Budget Planner - Financial Tracking System

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  categories    Category[]
  incomes       Income[]
  expenses      Expense[]
  transfers     Transfer[]
  budgets       Budget[]

  @@map("users")
}

enum AccountType {
  BANK
  CASH
  CREDIT
  INVESTMENT
  LOAN
  SAVINGS
  TITHE
  EMERGENCY_FUND
  FUND
}

enum CategoryType {
  INCOME
  EXPENSE
}

// Account model (Bank, Cash, Credit Card, Investment, Loan)
model Account {
  id          String      @id @default(cuid())
  name        String
  type        AccountType
  balance     Decimal     @db.Decimal(12, 2) // Current balance
  currency    String      @default("USD")
  icon        String?
  color       String?
  isLiability Boolean     @default(false)
  isArchived  Boolean     @default(false)  // Soft delete for data integrity
  creditLimit Decimal?    @db.Decimal(12, 2)

  // Fund-specific fields (only for EMERGENCY_FUND and FUND types)
  targetAmount        Decimal? @db.Decimal(12, 2) // Goal amount for FUND type
  fundCalculationMode String? // "MONTHS_COVERAGE" or "TARGET_PROGRESS"
  fundThresholdLow    Int?     @default(2) // Months for "Critical" status
  fundThresholdMid    Int?     @default(4) // Months for "Underfunded" status
  fundThresholdHigh   Int?     @default(6) // Months for "Funded" status

  userId      String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  incomes       Income[]
  expenses      Expense[]
  transfersFrom Transfer[] @relation("TransferFrom")
  transfersTo   Transfer[] @relation("TransferTo")

  @@unique([userId, name])
  @@index([userId, isArchived])
  @@map("accounts")
}

// Transfer model (Money movement between accounts)
model Transfer {
  id            String   @id @default(cuid())
  amount        Decimal  @db.Decimal(10, 2)
  fee           Decimal  @db.Decimal(10, 2) @default(0)  // Transfer/bank fee
  date          DateTime
  description   String?
  fromAccountId String
  toAccountId   String
  userId        String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  fromAccount Account @relation("TransferFrom", fields: [fromAccountId], references: [id], onDelete: Restrict)
  toAccount   Account @relation("TransferTo", fields: [toAccountId], references: [id], onDelete: Restrict)
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("transfers")
}

// Category model (for both income and expenses)
model Category {
  id        String       @id @default(cuid())
  name      String
  type      CategoryType
  icon      String?      // Emoji or icon identifier (customizable)
  color     String?      // Hex color code (customizable)
  userId    String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  incomes  Income[]
  expenses Expense[]
  budgets  Budget[]

  @@unique([userId, name, type])
  @@map("categories")
}

// Income model
model Income {
  id              String   @id @default(cuid())
  amount          Decimal  @db.Decimal(10, 2)
  description     String?
  date            DateTime
  isRecurring     Boolean  @default(false)
  recurringPeriod String?  // "MONTHLY", "WEEKLY", "YEARLY"
  categoryId      String
  accountId       String?  // Where the money went
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  category Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  account  Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("incomes")
}

// Expense model
model Expense {
  id              String   @id @default(cuid())
  amount          Decimal  @db.Decimal(10, 2)
  description     String?
  date            DateTime
  notes           String?  @db.Text
  isRecurring     Boolean  @default(false)
  recurringPeriod String?  // "MONTHLY", "WEEKLY", "YEARLY"
  categoryId      String
  budgetId        String?  // Optional: link to budget for tracking
  accountId       String?  // Where the money came from
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  category Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  budget   Budget?  @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  account  Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([budgetId])
  @@map("expenses")
}

// Budget model - Envelope Budgeting
// Each budget has a unique name, allowing multiple budgets per category
model Budget {
  id         String    @id @default(cuid())
  name       String    // e.g., "My Insurance", "Family Insurance"
  amount     Decimal   @db.Decimal(10, 2)
  month      DateTime  // First day of the month
  categoryId String
  userId     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenses Expense[] // Track expenses under this budget

  @@unique([userId, name, month])  // Unique by name+month (allows multiple per category)
  @@index([userId, month])
  @@index([userId, categoryId])    // For querying budgets by category
  @@map("budgets")
}
